# Service Location Integration Plan

This document outlines a comprehensive plan for integrating the `ServiceLocation` collection across the ISP Management Platform, ensuring a single source of truth for geographical data, streamlining UI workflows, and supporting advanced location-based features like the Network Map.

## 1. Core Principle: ServiceLocation as the Central Geographical Entity

All physical assets or entities that exist at a specific location will directly or indirectly relate to the `ServiceLocation` collection. This ensures consistency, avoids data redundancy, and simplifies updates.

## 2. Data Model: Relationships Breakdown

### 2.1. `ServiceLocation` Collection (Backend - Source of Truth)

*   **Purpose:** Represents a physical point or area where services are provided or devices are located.
*   **Key Fields (to be added/confirmed):**
    *   `id`: (Auto-generated by Payload) Unique identifier.
    *   `name`: (Text) Human-readable name (e.g., "Main Office Building", "Antenna Tower 3", "Apartment 4B").
    *   `latitude`: (Number) Geographical latitude coordinate. **(New)**
    *   `longitude`: (Number) Geographical longitude coordinate. **(New)**
    *   `ispOwner`: (Relationship to `Company`) For multi-tenancy.

### 2.2. Directly Linked to `ServiceLocation`

These collections will have a direct `relationship` field pointing to the `ServiceLocation` collection.

*   **`NetworkDevices`:**
    *   **Relationship:** `NetworkDevices.physicalLocation` -> `ServiceLocations.id`
    *   **Rationale:** A switch, router, or access point exists at one physical place.
*   **`Buildings`:**
    *   **Relationship:** `Buildings.location` -> `ServiceLocations.id`
    *   **Rationale:** Perfect for representing Multi-Dwelling Units (MDUs) or large business complexes. Replaces a simple address field with a geocoded location.
*   **`Subscribers`:**
    *   **Relationship:** `Subscribers.serviceAddress` -> `ServiceLocations.id`
    *   **Rationale:** A subscriber's service address is a physical location, distinct from their billing address.
*   **`Leads`:**
    *   **Relationship:** `Leads.location` -> `ServiceLocations.id`
    *   **Rationale:** Captures the lead's potential service location to assess serviceability.

### 2.3. Indirectly Linked (Through Other Collections)

These records do not need a direct link to `ServiceLocation` because their location is determined by the asset or person they are associated with.

*   **`Tickets` & `WorkOrders`:** Location is derived from the linked `Subscriber` or `NetworkDevice`.
    *   *Example Flow:* `Ticket` -> `Subscriber` -> `ServiceLocation`.
*   **`BuildingUnits`:** Location is implicitly defined by its parent `Building`.
    *   *Example Flow:* `BuildingUnit` -> `Building` -> `ServiceLocation`.
*   **`CrisisEvents`:** Location is tied to the `NetworkDevice` that triggered the event.
    *   *Example Flow:* `CrisisEvent` -> `NetworkDevice` -> `ServiceLocation`.
*   **`IP Addresses`:** Physical association is indirect, as they are assigned to a `Subscriber` or `NetworkDevice`.

### 2.4. Not Geographically Linked

These collections are administrative, financial, or logical and have no direct need for a physical location.

*   **Financial:** `Invoices`, `Payments`, `Expenses`, `Plans`.
*   **System & Admin:** `AuditLogs`, `Staff`, `Roles`, `Companies`, `Partners`.
*   **Communication:** `Messages`, `MessageTemplates`, `Contacts`.
*   **Logical:** `IP Subnets`.
*   **Assets:** `Media`.

## 3. Phased Implementation Plan

### Phase 1: Backend Data Model Updates

1.  **Add `latitude` and `longitude` to `ServiceLocations` collection.**
    *   File: `core-and-company/src/collections/ServiceLocations.ts`
2.  **Modify `Buildings` collection:**
    *   Remove `address` field (if present).
    *   Add `location` field (relationship to `ServiceLocation`).
    *   File: `core-and-company/src/collections/Buildings.ts`
3.  **Modify `Subscribers` collection:**
    *   Remove `addressNotes` field (if present).
    *   Add `serviceAddress` field (relationship to `ServiceLocation`).
    *   File: `core-and-company/src/collections/Subscribers.ts`
4.  **Modify `Leads` collection:**
    *   Remove `serviceLocation` (Text) field.
    *   Add `location` field (relationship to `ServiceLocation`).
    *   File: `core-and-company/src/collections/Leads.ts`
5.  **Rebuild and restart `payload` container.**

### Phase 2: Frontend Form Updates (Integrating ServiceLocation Selection)

1.  **Update `NetworkDevices` Add/Edit forms:**
    *   Modify `physicalLocation` field to use a dropdown for existing `ServiceLocations`.
    *   Implement "Add New Location" modal/drawer for on-the-fly `ServiceLocation` creation.
    *   Files: `frontend/app/dashboard/operations/network-devices/new/page.tsx`, `frontend/app/dashboard/operations/network-devices/[id]/edit/page.tsx`.
2.  **Update `Buildings` Add/Edit forms:**
    *   Modify `location` field to use `ServiceLocation` selection.
    *   Files: `frontend/app/dashboard/crm/buildings/new/page.tsx`, `frontend/app/dashboard/crm/buildings/[id]/edit/page.tsx`.
3.  **Update `Subscribers` Add/Edit forms:**
    *   Modify `serviceAddress` field to use `ServiceLocation` selection.
    *   Files: `frontend/app/dashboard/crm/subscribers/new/page.tsx`, `frontend/app/dashboard/crm/subscribers/[id]/edit/page.tsx`.
4.  **Update `Leads` Add/Edit forms:**
    *   Modify `location` field to use `ServiceLocation` selection.
    *   Files: `frontend/app/dashboard/crm/leads/new/page.tsx`, `frontend/app/dashboard/crm/leads/[id]/edit/page.tsx`.
5.  **Create mock `ServiceLocations` data for frontend development.**

### Phase 3: Frontend Network Map & Other Views (Using ServiceLocation Coordinates)

1.  **Update Network Map:**
    *   Fetch `NetworkDevices` and their associated `ServiceLocation` coordinates.
    *   Display devices on the geographical map using `ServiceLocation` `latitude`/`longitude`.
    *   File: `frontend/components/network-map.tsx`, `frontend/app/dashboard/operations/map/page.tsx`.
2.  **Update Detail Views:**
    *   Ensure `NetworkDevices`, `Buildings`, `Subscribers`, `Leads` detail views correctly display their linked `ServiceLocation` information.

## 4. Naming Convention

*   The term "ServiceLocation" will be used consistently across the platform to refer to geographical points.
*   Fields linking to `ServiceLocation` will be named descriptively (e.g., `physicalLocation` for devices, `location` for buildings/leads, `serviceAddress` for subscribers).
